<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Frame: jaga.id (monitoring)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 0; }
    header { background:#0b74da; color:#fff; padding:12px 16px; }
    main { padding: 12px; }
    #frameWrap { width: 100%; height: calc(100vh - 120px); border: 1px solid #ddd; box-sizing: border-box; overflow: hidden; }
    iframe { width: 100%; height: 100%; border: 0; display: block; }
    #status { margin-top:10px; font-weight:600; }
    #kontenProxy { width:100%; height:100%; overflow:auto; box-sizing:border-box; padding:12px; background:#fff; }
    .controls { margin-top:8px; }
    button { padding:8px 10px; margin-right:8px; cursor:pointer; }
    small.note { color:#555; display:block; margin-top:8px; }
  </style>
</head>
<body>
  <header>
    <h1 style="font-size:18px; margin:0">Embedded: jaga.id — Monitoring</h1>
  </header>

  <main>
    <div class="controls">
      <!-- Tombol manual jika mau paksa iframe atau proxy -->
      <button id="btnLoadIframe">Tampilkan via Iframe</button>
      <button id="btnLoadProxy">Tampilkan via Proxy</button>
      <span id="status">Status: siap.</span>
    </div>

    <div id="frameWrap" aria-live="polite">
      <!-- iframe atau konten proxy akan disisipkan di sini -->
    </div>

    <small class="note">
      Catatan: beberapa situs melarang tampil di iframe (header X-Frame-Options atau CSP). 
      Jika iframe kosong, sistem akan otomatis mencoba fallback ke proxy. Hasil proxy menampilkan HTML sumber — gaya/JS eksternal mungkin tidak bekerja sempurna.
    </small>
  </main>

  <script>
    // URL target yang diminta
    const targetUrl = "https://jaga.id/korwil/monitoring?year=2025&instansiId=506&templateId=1&version=my&betaVersion=2&vnk=5017a892";

    const frameWrap = document.getElementById("frameWrap");
    const statusEl = document.getElementById("status");
    const btnLoadIframe = document.getElementById("btnLoadIframe");
    const btnLoadProxy = document.getElementById("btnLoadProxy");

    // fungsi tulis status
    function setStatus(text) {
      statusEl.textContent = "Status: " + text;
    }

    // muat via iframe
    function loadIframe() {
      frameWrap.innerHTML = ""; // bersihkan
      setStatus("Mencoba memuat via iframe...");
      const iframe = document.createElement("iframe");
      iframe.src = targetUrl;
      // jangan gunakan sandbox kecuali memang perlu, karena bisa mematikan fungsi halaman
      let loaded = false;

      iframe.onload = () => {
        loaded = true;
        setStatus("✅ Berhasil dimuat dengan iframe.");
      };

      // onerror seringkali tidak ter-trigger ketika diblokir oleh X-Frame-Options,
      // jadi kita pakai timeout tambahan di bawah
      iframe.onerror = () => {
        setStatus("⚠️ Error saat mencoba memuat iframe — mencoba fallback proxy...");
        loadProxy();
      };

      frameWrap.appendChild(iframe);

      // fallback check setelah 2.5 detik: kalau contentWindow null atau kosong, paksa proxy
      setTimeout(() => {
        try {
          // beberapa browser memperbolehkan akses contentWindow, tetapi jika diblokir, frame mungkin kosong
          if (!loaded) {
            // cek apakah dokumen di dalam iframe tersedia (cross-origin biasanya blocking, tapi jika diblokir frame akan kosong)
            const cw = iframe.contentWindow;
            if (!cw || iframe.clientHeight === 0 || iframe.offsetHeight === 0) {
              setStatus("⚠️ Iframe kemungkinan diblokir oleh server (X-Frame-Options/CSP). Menggunakan proxy...");
              loadProxy();
            } else {
              // kalau belum loaded tapi contentWindow ada, beri waktu lebih
              setStatus("⏳ Iframe sedang dimuat...");
            }
          }
        } catch (e) {
          // akses ke contentWindow dari cross-origin akan melempar exception, tapi itu normal — jika load belum terjadi, tetap tunggu.
          if (!loaded) {
            setStatus("⚠️ Iframe cross-origin; menunggu onload atau fallback...");
            // beri kesempatan onload; jika tidak onload dalam beberapa detik lagi, fallback
            setTimeout(() => {
              if (!loaded) loadProxy();
            }, 2000);
          }
        }
      }, 2500);
    }

    // muat via proxy (AllOrigins). AllOrigins raw endpoint: https://api.allorigins.win/raw?url=<encoded>
    async function loadProxy() {
      frameWrap.innerHTML = ""; // bersihkan
      setStatus("⏳ Mengambil konten via proxy...");
      const konten = document.createElement("div");
      konten.id = "kontenProxy";
      konten.textContent = "Mengambil konten...";
      frameWrap.appendChild(konten);

      try {
        const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(targetUrl);
        const res = await fetch(proxyUrl);
        if (!res.ok) throw new Error("Response not OK: " + res.status);
        const html = await res.text();
        // masukkan html ke dalam kontainer
        konten.innerHTML = html;
        setStatus("✅ Konten dimuat via proxy (AllOrigins).");
      } catch (err) {
        konten.innerHTML = "<p style='color:crimson'>Gagal mengambil via proxy: " + (err.message || err) + "</p>";
        setStatus("❌ Gagal memuat via proxy.");
      }
    }

    // event tombol
    btnLoadIframe.addEventListener("click", loadIframe);
    btnLoadProxy.addEventListener("click", loadProxy);

    // load otomatis via iframe saat halaman dibuka
    loadIframe();
  </script>
</body>
</html>
